<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUVAT SPACE BOY</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styles --- */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Kanit', sans-serif;
            overflow: hidden;
            background-color: #000;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }

        #start-screen { display: flex; }

        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('https://img5.pic.in.th/file/secure-sv1/3e08b6045c468391c.png');
            background-size: cover;
            animation: scroll-background 20s linear infinite;
            overflow: hidden;
        }
        .game-container.turbo-warp {
            animation-duration: 1.5s;
        }
        .game-container.paused {
            animation-play-state: paused;
        }

        canvas {
            display: block;
            background: transparent;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* --- UI Elements --- */
        .top-ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ui-box {
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid white;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
        }
        #stats-btn {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #stats-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
        }
        .back-btn:hover { background-color: rgba(255, 255, 255, 0.2); }

        /* --- Start & Info Screens --- */
        #start-screen-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #start-screen-container img {
            max-width: 90%;
            max-height: 75vh;
            object-fit: contain;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.7);
        }
        .start-buttons {
             display: flex;
             flex-direction: row;
             flex-wrap: wrap;
             justify-content: center;
             align-items: center;
             gap: 15px;
             margin-top: 20px;
        }
        .btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            background: linear-gradient(45deg, #4CAF50, #81C784);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 180px;
        }
        #test-btn { background: linear-gradient(45deg, #0288D1, #29B6F6); }
        #learn-btn { background: linear-gradient(45deg, #FF9800, #FFB74D); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .btn:active { transform: translateY(1px); }

        #info-screen .form-container {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #info-screen input {
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 1.2rem;
            text-align: center;
        }

        /* --- Learn Screen --- */
        #learn-screen {
            background-color: #0d1b2a;
            justify-content: flex-start;
            padding-top: 80px;
        }
        .learn-content-container {
            width: 90%;
            max-width: 800px;
            height: calc(100% - 100px);
            overflow-y: auto;
            padding: 20px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 15px;
        }
        .learn-content-container h2 { color: #FFD700; }
        .formula-card {
            background-color: #2c3e50;
            border-left: 5px solid #FF9800;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: left;
        }
        .formula-card h3 { margin-top: 0; color: #64B5F6; }
        .formula-card .calculation {
            background-color: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            color: #4CAF50;
            font-weight: bold;
        }

        /* --- Game Screen --- */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 10px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            gap: 20px;
        }
        .control-btn {
            padding: 20px 10px;
            width: 40%;
            max-width: 200px;
            font-size: 1.6rem;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            text-align: center;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            box-shadow: inset 0 -6px 0 rgba(0,0,0,0.25), 0 6px 8px rgba(0,0,0,0.3);
            transition: all 0.1s ease-out;
        }
        .control-btn:active {
            transform: translateY(4px);
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25), 0 2px 3px rgba(0,0,0,0.2);
        }
        #up-btn { background: linear-gradient(145deg, #2196F3, #64B5F6); }
        #down-btn { background: linear-gradient(145deg, #FF9800, #FFB74D); }
        #turbo-warp-btn { background: linear-gradient(145deg, #9c27b0, #ba68c8); }
        
        #formula-display {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #fff;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            text-shadow: 2px 2px 4px #000;
            transition: all 0.2s;
        }
        #formula-display .placeholder, #formula-display .filled {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 35px;
            height: 35px;
            border-radius: 5px;
            font-size: 1.2rem;
        }
        #formula-display .placeholder { background-color: #fff; color: #000; }
        #formula-display .filled { background-color: #4CAF50; color: #fff; }
        #formula-display.fail { border-color: #f44336; transform: translateX(-50%) scale(1.05); }
        #formula-display.success { border-color: #4CAF50; background-color: #4CAF50; }

        /* --- Boss Screen --- */
        #boss-screen { background-color: #1a0c2e; }
        .boss-container {
            background-color: rgba(0,0,0,0.5);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            border: 2px solid #fff;
        }
        #boss-emoji { font-size: 5rem; margin-bottom: 20px; }
        #boss-question { font-size: 1.2rem; margin-bottom: 20px; }
        .answer-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .answer-options button {
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: 2px solid #fff;
            background-color: #4a148c;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .answer-options button:hover { background-color: #7b1fa2; }
        #fill-in-answer {
            padding: 15px;
            font-size: 1.2rem;
            text-align: center;
            border-radius: 10px;
            border: 2px solid #fff;
            width: 80%;
            margin: 0 auto 20px auto;
        }
        
        /* --- Stats Modal --- */
        #stats-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }
        .stats-content {
            background-color: #2c3e50;
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #7b1fa2;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        #stats-player-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e0e0e0;
            border-bottom: 2px solid #7b1fa2;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        #stats-history-container {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 10px;
        }
        .history-item {
            background-color: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: left;
        }
        .history-item p { margin: 5px 0; }
        .history-item .status-correct { color: #4CAF50; font-weight: bold; }
        .history-item .status-incorrect { color: #f44336; font-weight: bold; }

        @keyframes scroll-background {
            from { background-position: 0 0; }
            to { background-position: -1920px 0; }
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <div id="start-screen-container">
            <img src="https://img5.pic.in.th/file/secure-sv1/-32ef60d6dc88fcbf3.png" alt="ปกเกม SUVAT SPACE BOY">
            <div class="start-buttons">
                <button id="practice-btn" class="btn">ฝึกฝน</button>
                <button id="test-btn" class="btn">ทดสอบ</button>
                <button id="learn-btn" class="btn">เรียนรู้</button>
            </div>
        </div>
    </div>

    <div id="info-screen" class="screen">
        <div class="top-ui-container">
             <button class="back-btn ui-box">‹ กลับหน้าหลัก</button>
        </div>
        <div class="form-container">
            <h2>ข้อมูลผู้เล่น (โหมดทดสอบ)</h2>
            <input type="text" id="fullname" placeholder="ชื่อ-นามสกุล" required>
            <input type="text" id="class" placeholder="ชั้น" required>
            <input type="text" id="number" placeholder="เลขที่" required>
            <button id="play-game-btn" class="btn">เล่นเกม</button>
        </div>
    </div>

    <div id="learn-screen" class="screen">
        <div class="top-ui-container">
            <button class="back-btn ui-box">‹ กลับหน้าหลัก</button>
        </div>
        <div class="learn-content-container">
            <h2>สูตรการเคลื่อนที่แนวตรง (SUVAT)</h2>
            <div class="formula-card">
                <h3>1. v = u + at</h3>
                <p><strong>คำอธิบาย:</strong> หาความเร็วสุดท้าย (v) เมื่อทราบความเร็วต้น (u), ความเร่ง (a), และเวลา (t)</p>
                <p><strong>ตัวอย่าง:</strong> รถไฟเริ่มเคลื่อนที่จากหยุดนิ่ง (u=0) ด้วยความเร่ง 2 m/s² เป็นเวลา 10 วินาที</p>
                <p class="calculation">v = 0 + (2 * 10) = 20 m/s</p>
            </div>
            <div class="formula-card">
                <h3>2. s = ut + ½at²</h3>
                <p><strong>คำอธิบาย:</strong> หาระยะทาง (s) เมื่อทราบความเร็วต้น (u), เวลา (t), และความเร่ง (a)</p>
                <p><strong>ตัวอย่าง:</strong> ก้อนหินถูกปล่อยจากหน้าผา (u=0) โดยมีความเร่งโน้มถ่วง 9.8 m/s² เป็นเวลา 3 วินาที</p>
                <p class="calculation">s = (0 * 3) + 0.5 * 9.8 * (3²) = 44.1 เมตร</p>
            </div>
            <div class="formula-card">
                <h3>3. v² = u² + 2as</h3>
                <p><strong>คำอธิบาย:</strong> หาความเร็วสุดท้าย (v) เมื่อไม่ทราบเวลา (t) แต่ทราบระยะทาง (s)</p>
                <p><strong>ตัวอย่าง:</strong> นักปั่นจักรยานเร่งจาก 5 m/s (u=5) ด้วยความเร่ง 1 m/s² เป็นระยะทาง 50 เมตร</p>
                <p class="calculation">v² = 5² + 2 * 1 * 50 = 25 + 100 = 125</p>
                <p class="calculation">v = √125 ≈ 11.18 m/s</p>
            </div>
            <div class="formula-card">
                <h3>4. s = ½(u + v)t</h3>
                <p><strong>คำอธิบาย:</strong> หาระยะทาง (s) เมื่อทราบความเร็วต้น (u), ความเร็วสุดท้าย (v), และเวลา (t)</p>
                <p><strong>ตัวอย่าง:</strong> รถยนต์เคลื่อนที่เป็นเวลา 10 วินาที จากความเร็ว 10 m/s (u=10) เป็น 30 m/s (v=30)</p>
                <p class="calculation">s = 0.5 * (10 + 30) * 10 = 0.5 * 40 * 10 = 200 เมตร</p>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="top-ui-container">
            <div>
                 <button class="back-btn ui-box">‹ กลับหน้าหลัก</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <span id="stats-btn" class="ui-box">สถิติ</span>
                <span id="score-display" class="ui-box">คะแนน: 0</span>
            </div>
        </div>
        <div id="formula-display"></div>
        <div id="game-container" class="game-container">
            <canvas id="gameCanvas"></canvas>
        </div>
        <div class="controls">
            <button id="up-btn" class="control-btn">ขึ้น</button>
            <button id="down-btn" class="control-btn">ลง</button>
            <button id="turbo-warp-btn" class="control-btn" style="display: none;">วาร์ป!</button>
        </div>
    </div>

    <div id="boss-screen" class="screen">
        <div class="top-ui-container">
            <div></div> <!-- Spacer -->
            <div id="score-display-boss" class="ui-box">คะแนน: 0</div>
        </div>
        <div class="boss-container">
            <div id="boss-emoji"></div>
            <div id="boss-question"></div>
            <div id="mcq-section">
                <div class="answer-options">
                    <button class="answer-btn"></button>
                    <button class="answer-btn"></button>
                    <button class="answer-btn"></button>
                </div>
            </div>
            <div id="fill-in-section" style="display: none;">
                <input type="number" id="fill-in-answer" placeholder="ใส่คำตอบเป็นตัวเลข">
                <button id="submit-answer-btn" class="btn">ส่งคำตอบ</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="stats-modal">
        <div class="stats-content">
            <div id="stats-player-info"></div>
            <div id="stats-history-container"></div>
            <button id="resume-game-btn" class="btn" style="margin-top: 20px;">กลับไปเล่นเกม</button>
        </div>
    </div>


    <script>
        // --- Global State ---
        let animationId = null;
        let score = 0;
        let lastFormulaIndex = -1;
        let lastBossQuestions = [];
        let playerInfo = {};
        let answerHistory = [];
        let isGamePaused = false;

        // --- DOM Elements ---
        const screens = {
            start: document.getElementById('start-screen'),
            info: document.getElementById('info-screen'),
            game: document.getElementById('game-screen'),
            boss: document.getElementById('boss-screen'),
            learn: document.getElementById('learn-screen')
        };
        const buttons = {
            practice: document.getElementById('practice-btn'),
            test: document.getElementById('test-btn'),
            learn: document.getElementById('learn-btn'),
            play: document.getElementById('play-game-btn'),
            back: document.querySelectorAll('.back-btn'),
            submitAnswer: document.getElementById('submit-answer-btn'),
            turboWarp: document.getElementById('turbo-warp-btn'),
            stats: document.getElementById('stats-btn'),
            resume: document.getElementById('resume-game-btn')
        };
        const scoreDisplays = {
            game: document.getElementById('score-display'),
            boss: document.getElementById('score-display-boss')
        };
        const statsModal = {
            modal: document.getElementById('stats-modal'),
            playerInfo: document.getElementById('stats-player-info'),
            historyContainer: document.getElementById('stats-history-container')
        };

        // --- Screen Navigation ---
        const goToScreen = (screenName) => {
            Object.values(screens).forEach(s => s.style.display = 'none');
            screens[screenName].style.display = 'flex';
        };

        buttons.practice.addEventListener('click', () => {
            playerInfo = { name: 'บุคคลนิรนามผู้กำลังฝึกวิทยายุทธ', class: '', number: '' };
            goToScreen('game');
            initGame();
        });
        buttons.test.addEventListener('click', () => goToScreen('info'));
        buttons.learn.addEventListener('click', () => goToScreen('learn'));
        buttons.play.addEventListener('click', () => {
            const name = document.getElementById('fullname').value;
            const p_class = document.getElementById('class').value;
            const p_num = document.getElementById('number').value;
            if (name && p_class && p_num) {
                playerInfo = { name, class: p_class, number: p_num };
                goToScreen('game');
                initGame();
            } else {
                alert('กรุณากรอกข้อมูลให้ครบทุกช่อง');
            }
        });
        buttons.back.forEach(btn => {
            btn.addEventListener('click', () => {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                // --- RESETTING GLOBAL STATE ---
                score = 0;
                answerHistory = [];
                lastFormulaIndex = -1;
                lastBossQuestions = [];
                isGamePaused = false;
                document.getElementById('game-container').classList.remove('paused');
                // --- END RESET ---
                goToScreen('start');
            });
        });

        const handleWarp = () => {
            const gameContainer = document.getElementById('game-container');
            if (gameContainer.classList.contains('turbo-warp')) return;

            gameContainer.classList.add('turbo-warp');
            document.querySelectorAll('.control-btn').forEach(b => b.disabled = true);

            setTimeout(() => {
                if (animationId) cancelAnimationFrame(animationId);
                gameContainer.classList.remove('turbo-warp');
                document.querySelectorAll('.control-btn').forEach(b => b.disabled = false);
                goToScreen('boss');
                initBossFight();
            }, 1500);
        };

        buttons.turboWarp.addEventListener('click', handleWarp);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && buttons.turboWarp.style.display !== 'none') {
                handleWarp();
            }
        });

        function updateScoreDisplay() {
            scoreDisplays.game.textContent = `คะแนน: ${score}`;
            scoreDisplays.boss.textContent = `คะแนน: ${score}`;
        }

        // --- Pause & Stats Logic ---
        const pauseGame = () => {
            if (isGamePaused) return;
            isGamePaused = true;
            cancelAnimationFrame(animationId);
            animationId = null;
            document.getElementById('game-container').classList.add('paused');
            populateStatsModal();
            statsModal.modal.style.display = 'flex';
        };

        const resumeGame = () => {
            if (!isGamePaused) return;
            isGamePaused = false;
            statsModal.modal.style.display = 'none';
            document.getElementById('game-container').classList.remove('paused');
            initGameLoop();
        };

        buttons.stats.onclick = pauseGame;
        buttons.resume.onclick = resumeGame;

        function populateStatsModal() {
            let infoHtml = '';
            if (playerInfo.class) {
                infoHtml = `ผู้เล่น: ${playerInfo.name}<br>ชั้น: ${playerInfo.class} เลขที่: ${playerInfo.number}`;
            } else {
                infoHtml = playerInfo.name;
            }
            infoHtml += `<br><b style="color: #FFD700;">คะแนนปัจจุบัน: ${score}</b>`;
            statsModal.playerInfo.innerHTML = infoHtml;

            statsModal.historyContainer.innerHTML = '';
            if (answerHistory.length === 0) {
                statsModal.historyContainer.innerHTML = '<p>ยังไม่มีประวัติการตอบคำถาม</p>';
                return;
            }
            answerHistory.slice().reverse().forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                const statusClass = item.isCorrect ? 'status-correct' : 'status-incorrect';
                const statusText = item.isCorrect ? 'ถูกต้อง' : 'ผิด';
                itemDiv.innerHTML = `
                    <p><b>คำถาม:</b> ${item.question}</p>
                    <p><b>คำตอบของคุณ:</b> ${item.yourAnswer || '-'}</p>
                    <p class="${statusClass}"><b>ผลลัพธ์:</b> ${statusText}</p>
                `;
                statsModal.historyContainer.appendChild(itemDiv);
            });
        }

        // --- Game Logic ---
        let gameInstance = {};

        function initGame() {
            isGamePaused = false;
            gameInstance.canvas = document.getElementById('gameCanvas');
            gameInstance.ctx = gameInstance.canvas.getContext('2d');
            gameInstance.gameContainer = document.getElementById('game-container');
            gameInstance.formulaDisplay = document.getElementById('formula-display');
            
            updateScoreDisplay();

            gameInstance.canvas.width = gameInstance.gameContainer.clientWidth;
            gameInstance.canvas.height = gameInstance.gameContainer.clientHeight;
            window.onresize = () => {
                if(gameInstance.canvas) {
                    gameInstance.canvas.width = gameInstance.gameContainer.clientWidth;
                    gameInstance.canvas.height = gameInstance.gameContainer.clientHeight;
                }
            };

            gameInstance.allPossibleVars = ['s', 'u', 'v', 'a', 't', 'u²', 'v²', 't²'];
            gameInstance.stars = [];
            gameInstance.frame = 0;
            gameInstance.portal = null;
            gameInstance.speed = 2;

            gameInstance.formulas = [
                { template: ['[v]', ' = ', '[u]', ' + ', '[a]', '[t]'], vars: ['v', 'u', 'a', 't'] },
                { template: ['[s]', ' = ', '[u]', '[t]', ' + ½', '[a]', '[t²]'], vars: ['s', 'u', 't', 'a', 't²'] },
                { template: ['[v²]', ' = ', '[u²]', ' + 2', '[a]', '[s]'], vars: ['v²', 'u²', 'a', 's'] },
                { template: ['[s]', ' = ½(', '[u]','+', '[v]', ')', '[t]'], vars: ['s', 'u', 'v', 't'] }
            ];
            
            gameInstance.player = {
                x: 100, y: gameInstance.canvas.height / 2,
                width: 180, height: 80,
                img: new Image(),
                imgWidth: 200, imgHeight: 100,
                speedY: 0, moveUp: false, moveDown: false
            };
            gameInstance.player.img.src = 'https://img5.pic.in.th/file/secure-sv1/286f5cf088c1e26b1.png';
            gameInstance.player.img.onerror = () => console.error("Failed to load player image.");

            const upBtn = document.getElementById('up-btn');
            const downBtn = document.getElementById('down-btn');
            const handleUp = (state) => { gameInstance.player.moveUp = state; };
            const handleDown = (state) => { gameInstance.player.moveDown = state; };
            upBtn.ontouchstart = (e) => { e.preventDefault(); handleUp(true); };
            upBtn.ontouchend = (e) => { e.preventDefault(); handleUp(false); };
            downBtn.ontouchstart = (e) => { e.preventDefault(); handleDown(true); };
            downBtn.ontouchend = (e) => { e.preventDefault(); handleDown(false); };
            upBtn.onmousedown = () => handleUp(true);
            upBtn.onmouseup = () => handleUp(false);
            downBtn.onmousedown = () => handleDown(true);
            downBtn.onmouseup = () => handleDown(false);
            
            const handleKeyPress = (e) => {
                if(isGamePaused) return;
                if (e.key === 'ArrowUp') handleUp(true);
                if (e.key === 'ArrowDown') handleDown(true);
            };
            const handleKeyRelease = (e) => {
                if (e.key === 'ArrowUp') handleUp(false);
                if (e.key === 'ArrowDown') handleDown(false);
            };
            window.onkeydown = handleKeyPress;
            window.onkeyup = handleKeyRelease;
            
            setupNewFormula();
            gameInstance.player.img.onload = () => initGameLoop();
            if (gameInstance.player.img.complete) initGameLoop();
        }

        function setupNewFormula() {
            gameInstance.portal = null;
            gameInstance.formulaDisplay.classList.remove('success');
            buttons.turboWarp.style.display = 'none';
            document.getElementById('up-btn').style.display = 'inline-block';
            document.getElementById('down-btn').style.display = 'inline-block';

            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * gameInstance.formulas.length);
            } while (newIndex === lastFormulaIndex);
            lastFormulaIndex = newIndex;

            gameInstance.currentFormula = gameInstance.formulas[newIndex];
            gameInstance.targetVariables = gameInstance.currentFormula.vars;
            gameInstance.collectedVariables = [];
            updateFormulaDisplay();
        }
        
        function updateFormulaDisplay() {
            gameInstance.formulaDisplay.innerHTML = '';
            let varIndex = 0;
            gameInstance.currentFormula.template.forEach(part => {
                if (part.startsWith('[')) {
                    const span = document.createElement('span');
                    if (varIndex < gameInstance.collectedVariables.length) {
                        span.textContent = gameInstance.collectedVariables[varIndex];
                        span.className = 'filled';
                    } else {
                        span.textContent = '?';
                        span.className = 'placeholder';
                    }
                    gameInstance.formulaDisplay.appendChild(span);
                    varIndex++;
                } else {
                    gameInstance.formulaDisplay.appendChild(document.createTextNode(part));
                }
            });
        }
        
        function handleIncorrectCollection() {
            gameInstance.collectedVariables = [];
            updateFormulaDisplay();
            gameInstance.formulaDisplay.classList.add('fail');
            setTimeout(() => gameInstance.formulaDisplay.classList.remove('fail'), 500);
        }
        
        function handleFormulaComplete() {
            gameInstance.formulaDisplay.classList.add('success');
            gameInstance.portal = {
                x: gameInstance.canvas.width - 100,
                y: Math.random() * (gameInstance.canvas.height - 100),
                size: 50,
                rotation: 0
            };
            buttons.turboWarp.style.display = 'inline-block';
            document.getElementById('up-btn').style.display = 'none';
            document.getElementById('down-btn').style.display = 'none';
        }

        function drawStarShape(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx; let y = cy;
            let step = Math.PI / spikes;
            const ctx = gameInstance.ctx;
            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y); rot += step;
                x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y); rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius); ctx.closePath();
        }
        
        function handleStars() {
            if (gameInstance.frame % 75 === 0 && !gameInstance.portal) {
                let letterToSpawn;
                const chanceForCorrect = 0.4;
                if (Math.random() < chanceForCorrect) {
                    letterToSpawn = gameInstance.targetVariables[gameInstance.collectedVariables.length];
                } else {
                    letterToSpawn = gameInstance.allPossibleVars[Math.floor(Math.random() * gameInstance.allPossibleVars.length)];
                }
                gameInstance.stars.push({
                    x: gameInstance.canvas.width, y: Math.random() * (gameInstance.canvas.height - 50),
                    size: 35,
                    letter: letterToSpawn,
                    speed: gameInstance.speed + Math.random() * 2
                });
            }
            for (let i = gameInstance.stars.length - 1; i >= 0; i--) {
                const star = gameInstance.stars[i];
                star.x -= star.speed;
                gameInstance.ctx.fillStyle = '#FFD700';
                drawStarShape(star.x, star.y, 5, star.size, star.size / 2);
                gameInstance.ctx.fill();
                gameInstance.ctx.fillStyle = 'black';
                gameInstance.ctx.font = 'bold 24px Kanit';
                gameInstance.ctx.textAlign = 'center'; gameInstance.ctx.textBaseline = 'middle';
                gameInstance.ctx.fillText(star.letter, star.x, star.y);
                
                const player = gameInstance.player;
                const playerHitboxX = player.x + (player.imgWidth - player.width) / 2;
                const playerHitboxY = player.y + (player.imgHeight - player.height) / 2;
                const starHitboxX = star.x - star.size;
                const starHitboxY = star.y - star.size;
                const starHitboxSize = star.size * 2;

                if (playerHitboxX < starHitboxX + starHitboxSize && playerHitboxX + player.width > starHitboxX &&
                    playerHitboxY < starHitboxY + starHitboxSize && playerHitboxY + player.height > starHitboxY) {
                    
                    if (!gameInstance.portal) {
                        const targetLetter = gameInstance.targetVariables[gameInstance.collectedVariables.length];
                        if (star.letter === targetLetter) {
                            gameInstance.collectedVariables.push(star.letter);
                            updateFormulaDisplay();
                            if(gameInstance.collectedVariables.length === gameInstance.targetVariables.length) {
                                handleFormulaComplete();
                            }
                        } else {
                            handleIncorrectCollection();
                        }
                    }
                    gameInstance.stars.splice(i, 1);
                    continue;
                }
                if (star.x + star.size < 0) { gameInstance.stars.splice(i, 1); }
            }
        }
        
        function handlePortal() {
            const portal = gameInstance.portal;
            if (!portal) return;
            portal.rotation += 0.05;
            const ctx = gameInstance.ctx;
            ctx.save();
            ctx.translate(portal.x, portal.y);
            ctx.rotate(portal.rotation);
            const gradient = ctx.createRadialGradient(0, 0, portal.size * 0.5, 0, 0, portal.size);
            gradient.addColorStop(0, '#fff');
            gradient.addColorStop(0.5, '#9c27b0');
            gradient.addColorStop(1, '#000');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(0, 0, portal.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function updatePlayer() {
            const player = gameInstance.player;
            player.speedY = 0;
            if (player.moveUp) player.speedY = -5;
            if (player.moveDown) player.speedY = 5;
            player.y += player.speedY;
            if (player.y < 0) player.y = 0;
            if (player.y > gameInstance.canvas.height - player.imgHeight) {
                player.y = gameInstance.canvas.height - player.imgHeight;
            }
        }
        
        function drawPlayer() {
            const player = gameInstance.player;
            gameInstance.ctx.drawImage(player.img, player.x, player.y, player.imgWidth, player.imgHeight);
        }
        
        function initGameLoop() {
            if (isGamePaused) return;

            if (score >= 10) {
                gameInstance.speed = Math.min(5, 2 + (score - 10) * 0.05);
            } else {
                gameInstance.speed = 2;
            }

            gameInstance.ctx.clearRect(0, 0, gameInstance.canvas.width, gameInstance.canvas.height);
            updatePlayer();
            drawPlayer();
            handleStars();
            handlePortal();
            gameInstance.frame++;
            animationId = requestAnimationFrame(initGameLoop);
        }

        // --- Boss Fight Logic ---
        function initBossFight() {
            const bossEmoji = document.getElementById('boss-emoji');
            const bossQuestion = document.getElementById('boss-question');
            const mcqSection = document.getElementById('mcq-section');
            const fillInSection = document.getElementById('fill-in-section');
            const answerButtons = document.querySelectorAll('.answer-btn');
            const fillInInput = document.getElementById('fill-in-answer');
            
            updateScoreDisplay();

            const emojis = ['👽', '👾', '🤖', '🎃', '👹', '🤡'];
            const allBossQuestions = [
                {
                    type: 'mcq', id: 1,
                    setup: () => {
                        const u = Math.floor(Math.random() * 5) + 1, t = Math.floor(Math.random() * 5) + 2, a = 2, v = u + a * t;
                        const questionText = `วัตถุมีความเร็วต้น ${u} m/s เคลื่อนที่ด้วยความเร่ง ${a} m/s² เป็นเวลา ${t} วินาที จะมีความเร็วสุดท้ายเท่าใด?`;
                        bossQuestion.textContent = questionText;
                        const options = [v, v + 2, v - 1].sort(() => Math.random() - 0.5);
                        answerButtons.forEach((btn, i) => {
                            btn.textContent = `${options[i]} m/s`;
                            btn.onclick = () => handleAnswer(options[i] === v, questionText, `${options[i]} m/s`);
                        });
                    }
                },
                {
                    type: 'fill', id: 2,
                    setup: () => {
                        const v = (Math.floor(Math.random() * 5) + 5) * 2, u = Math.floor(Math.random() * 4) * 2, t = 2, s = 0.5 * (u + v) * t;
                        const questionText = `รถยนต์เคลื่อนที่ ${t} วินาที จากความเร็ว ${u} m/s เป็น ${v} m/s ได้ระยะทางเท่าใด (m)?`;
                        bossQuestion.textContent = questionText;
                        buttons.submitAnswer.onclick = () => handleAnswer(Number(fillInInput.value) === s, questionText, fillInInput.value);
                    }
                },
                {
                    type: 'mcq', id: 3,
                    setup: () => {
                        const s = (Math.floor(Math.random() * 5) + 5) * 10, t = 10, v_avg = s / t;
                        const questionText = `นักวิ่ง วิ่งได้ระยะทาง ${s} เมตร ในเวลา ${t} วินาที ความเร็วเฉลี่ยของเขาคือเท่าใด?`;
                        bossQuestion.textContent = questionText;
                        const options = [v_avg, v_avg + 1, v_avg - 1].sort(() => Math.random() - 0.5);
                        answerButtons.forEach((btn, i) => {
                            btn.textContent = `${options[i]} m/s`;
                            btn.onclick = () => handleAnswer(options[i] === v_avg, questionText, `${options[i]} m/s`);
                        });
                    }
                },
                {
                    type: 'fill', id: 4,
                    setup: () => {
                        const u = 20, a = -2, v = 10, t = (v - u) / a;
                        const questionText = `รถเบรกจากความเร็ว ${u} m/s จนเหลือ ${v} m/s ด้วยความหน่วง ${-a} m/s² ต้องใช้เวลากี่วินาที?`;
                        bossQuestion.textContent = questionText;
                        buttons.submitAnswer.onclick = () => handleAnswer(Number(fillInInput.value) === t, questionText, fillInInput.value);
                    }
                }
            ];
            
            let questionNumber = 1;
            
            const availableQuestions = allBossQuestions.filter(q => !lastBossQuestions.includes(q.id));
            const shuffled = availableQuestions.sort(() => 0.5 - Math.random());
            const questionsForThisRound = shuffled.slice(0, 2);
            lastBossQuestions = questionsForThisRound.map(q => q.id);

            function setupQuestion(qNum) {
                fillInInput.value = '';
                mcqSection.style.display = 'none';
                fillInSection.style.display = 'none';

                const questionData = questionsForThisRound[qNum - 1];
                if (!questionData) {
                    goToScreen('game');
                    initGame();
                    return;
                }
                questionData.setup();
                if(questionData.type === 'mcq') {
                    mcqSection.style.display = 'block';
                } else {
                    fillInSection.style.display = 'block';
                }
            }

            function handleAnswer(isCorrect, questionText, yourAnswer) {
                if (isCorrect) {
                    score++;
                    updateScoreDisplay();
                }
                answerHistory.push({ question: questionText, yourAnswer, isCorrect });

                if (questionNumber === 1) {
                    questionNumber++;
                    setupQuestion(2);
                } else {
                    goToScreen('game');
                    initGame();
                }
            }

            bossEmoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            setupQuestion(1);
        }
    </script>
</body>
</html>
